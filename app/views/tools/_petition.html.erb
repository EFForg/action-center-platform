<script>
  var petition_id = "<%= @petition.id %>";
  var institutions = <%= raw @institutions.to_json( :only => [:id, :name] ) %>
  var international_only = <%= params.include?('international_only') and params['international_only'] == "true" ? "true" : "false" %>;
</script>
<script type='text/x-underscore-template' id='individual_signature'>
  <tr>
    <td>
      <div>{{ name }}</div>
      <div>{{ location }}</div>
    </td>
    <td class="timeago">
      {{ time_ago }}
    </td>
  </tr>
</script>
<div id='petition-tool' class="tool <%= 'un' unless current_user.try(:signed?, @actionPage.petition) || params[:thankyou] -%>signed">
  <div class="tool-container">

    <div class="tool-heading">
      <h2 class="tool-title signed">
        <span class='glyphicon glyphicon-ok'></span>Signed
      </h2>
      <h2 class="tool-title unsigned">
        <%= t :sign_the_petition -%>
      </h2>
    </div>

    <div class="tool-body">
      <%- if @petition.enable_affiliations -%>
        <div class='small tool-notice'>
          <%= t :name_and_affiliations_published -%>
        </div>
      <% end %>

      <%- if @actionPage.petition.goal -%>
        <div id="progress-bar">
          <div class='count'><b><%= @signature_count -%></b> /
            <span class='goal'><%= @actionPage.petition.goal -%> <%= t :signatures -%></span>
          </div>
          <div class="progress">
            <div class="progress-bar progress-bar-danger signatures-bar" role="progressbar" aria-valuenow="<%= @signature_count -%>>" aria-valuemin="0" aria-valuemax="<%= @actionPage.petition.goal-%>" style="width: <%= @actionPage.petition.percent_complete -%>%">
            </div>
          </div>
        </div>
      <% else %>
        <div id="progress-bar">
          <div class='count'><b><%= @signature_count -%></b><span class='goal'> <%= t :signatures -%></span>
          </div>
        </div>
      <% end -%>

        <div class='signed'>
          <div class='vertical-share'>
            <b class='small'>Now help spread the word:</b>
            <a href='<%= twitter_share_url(@actionPage) -%>' class='twitter twitter-button'>
              <div class="sicon" id="stwit"></div>
              <div class="share-label">Share on Twitter</div>
            </a>
            <a href='<%= facebook_share_url(@actionPage) -%>' class='facebook facebook-button'>
              <div class="sicon" id="sfb"></div>
              <div class="share-label">Share on Facebook</div>
            </a>
            <a href='<%= google_share_url(@actionPage) -%>' class='google google-button'>
              <div class="sicon" id="sgplus"></div>
              <div class="share-label">Share on Google+</div>
            </a>
          </div>
          <b class='small'>
            Have you
            <a href='https://supporters.eff.org/donate' target='blank'>donated to EFF</a>
            lately?
            <% if !current_user %>
            <br />
            <strong><a href="/register">Sign up</a> for an EFF Action account and save your information for next time.</strong>
            <% end %>
          </b>
        </div>
        <div class='unsigned'>
          <%= form_for @signature, url: '/tools/petition',
            html: {class: 'petition-tool'} do |f| -%>
            <%= f.hidden_field :petition_id -%>
            <input type="hidden" name="action_id" value="<%= @actionPage.id %>" />

            <fieldset>
              <%= f.email_field :email, placeholder: 'Email', required: true,
                class: 'form-control', pattern: '.*\S+.*', title: t('petition_errors.required.email')
              -%>
            </fieldset>
            <fieldset>
              <%= f.text_field :first_name, placeholder: t(:first_name), required: true,
                class: 'form-control', pattern: '.*\S+.*', title: t('petition_errors.required.first_name')
              -%>
            </fieldset>
            <fieldset>
              <%= f.text_field :last_name, placeholder: t(:last_name), required: true,
                class: 'form-control', pattern: '.*\S+.*', title: t('petition_errors.required.last_name')
              -%>
            </fieldset>

            <% if @actionPage.petition.enable_affiliations %>
              <div id='affiliations'>
                <%= f.fields_for :affiliations, Affiliation.new do |affiliation| %>
                  <%= render 'affiliations/affiliation_fields', :f => affiliation %>
                <% end %>
                <div class='links text-right'>
                  <%= link_to_add_association t(:add_another_institution), f, :affiliations, partial: 'affiliations/affiliation_fields' %>
                </div>
              </div>
            <% end %>

            <% if @require_location %>
              <%= render 'tools/petition_location', f: f %>
            <% end %>

            <fieldset>
              <% unless @petition.enable_affiliations %>
                <div class='checkbox small'>
                  <%= f.label :anonymous, class: :small do -%>
                    <%= check_box_tag 'signature[anonymous]' -%>
                    <%= t :dont_show_my_name -%>
                  <% end -%>
                </div>
              <% end %>

              <%- unless user_signed_in? -%>
                <div class="email-signup">
                  <%= t :i -%>
                  <input type="radio" name="subscribe" value="1" <%= 'checked' if params[:subscribe] == '1' -%> id="do-subscribe" >
                  <label class="radio-inline" for="do-subscribe"><%= t :want -%></label>

                  <input type="radio" name="subscribe" value="0" <%= 'checked' unless params[:subscribe] == '1' -%> id="do-not-subscribe">
                  <label class="radio-inline" for="do-not-subscribe"><%= t :do_not_want -%></label>
                  <%= t :to_sign_up_for_mailings_from -%> <b><%= t :organization_abbreviation -%></b>
                </div>
              <% end -%>

              <% unless @require_location %>
                <%= render 'tools/petition_location', f: f %>
              <% end %>

              <% if @actionPage.partner -%>
                <div class="email-signup">
                  <%= t :i -%>
                  <input type="radio" name="partner_newsletter" value="<%= @actionPage.partner.code -%>" id="partner_subscribe">
                  <label class="radio-inline" for="partner_subscribe"><%= t :want -%></label>
                  <input type="radio" name="partner_newsletter" value="" id="partner_do_not_subscribe" checked>
                  <label class="radio-inline" for="partner_do_not_subscribe"><%= t :do_not_want -%></label>
                  <%= t :to_sign_up_for_mailings_from -%> <b><%= @actionPage.partner.name -%></b>
                  (<%= link_to 'privacy policy', @actionPage.partner.privacy_url -%>).
                </div>
              <% end -%>

              <%= render 'tools/save_my_info_option', info: t(%w[email name location]) -%>

            </fieldset>
            <h3 class="privacy-notice-header">
              <em>How will EFF use this information?</em>
              <span class="privacy-notice-popover" data-container="body" data-toggle="popover" data-trigger="hover" data-placement="auto bottom" data-content="We use this information to help you contact decision makers (e.g. Members of Congress) and their staff. We may work with other groups to assist in this action, such as sharing and jointly delivering petition signatures with a coalition partner. We may use Action Center information to assess the success of action campaigns and to improve the functionality and effectiveness of our site, and to allow you to see records of your activities. We, and our coalition partners, may publicize and share aggregate information about action campaigns, such as the number of people who participated in a particular location or region or through a type of action, as well as sharing or publicizing activity trends.">?</span>
            </h3>
            <% button_text = params.include?("button_text") ? params["button_text"].to_sym : t(:speak_out) %>
            <%= f.submit button_text, class: 'btn'-%>
            <%= render 'tools/loading' -%>
          <% end %>
      </div>
    </div>
  </div>
</div>

<% if !@petition.enable_affiliations? -%>
<div id='signatures' class="hidden-xs ajax-update">
  <h4 class='header'><em><%= t :recent_signatories -%></em></h4>
  <%= render(partial: "tools/signatures", layout: false) %>
</div>
<% end -%>